---
title: "RRR: Reproduzindo o Resampling com Rsampling"
author: "Paulo Inácio Prado"
date: "Junho de 2015"
output: rmarkdown::html_vignette
	      fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---



## Instalação
O Rsampling está hospedado no GitHub.
Para instalá-lo use a função `install_github` do pacote devtools:

```r{installation}
library(devtools)
install_github(repos = 'Rsampling', username = 'lageIBUSP')
```

## Exemplos

### Embaralhando uma coluna para testar diferença entre grupos

O dataframe `embauba` tem os dados de presença
e ausência de lianas em embaúbas de dois morfotipos (brancas e vermelhas).

```{r inspecionando objeto embauba}
head(embauba)
summary(embauba)
```
Para mais detalhes sobre os dados e o estudo que os produziu consulte a
página de ajuda (`?embauba`).

#### Hipótese do estudo
Uma das hipóteses deste estudo é
que embaúbas vermelhas seriam menos infestadas por lianas do que as
brancas, por abrigarem colônias de formigas mais frequentemente.
De fato
esta diferença ocorreu nas proporções de árvores
infestadas na amostra:

```{r proporcao de infestacao por morfo de embauba}
tapply(embauba$with.vines, embauba$morphotype, mean)
```
#### Hipótese nula
A hipótese nula é de que as proporções de infestação são iguais
na população de onde vieram as amostras.
Sob esta hipótese, uma liana tem a mesma chance de estar em uma embaúba
branca ou vermelha.
Simulamos a hipótese nula
embaralhando as presenças de lianas entre plantas
na tabela de dados.

#### Estatística de interesse
A cada simulação temos que calcular nossa
**estatística de interesse**, que é a
a diferença de infestação
entre os dois morfos.
Criamos uma função para isso:

```{r estatistica de interesse embaubas}
emb.ei <- function(dataframe){
    props <- tapply(dataframe$with.vines, dataframe$morphotype, mean)
    props[[1]] - props[[2]]
}
## Verificando
emb.ei(embauba)
```
#### Distribuição da estatística sob a hipótese nula

Em seguida fazemos a simulação com a função
`Rsampling`:

```{r embaubas resampling}
emb.r <- Rsampling(type = "normal", dataframe = embauba,
                   statistics = emb.ei, cols = 2, ntrials = 1000)
```
**O que significa este comando?**
* `type = "normal` escolhe uma randomização de todos os elementos
		(mais abaixo você verá outros tipos de randomização).
* `dataframe = embauba` indica a tabela com os dados
* `statistics = emb.ei` indica a função que calcula a(s)
	estatística(s) de interesse da tabela de dados.
* `cols = 2` indica que a randomização deve ser feita sobre a segunda
  coluna da tabela de dados.
* `ntrials = 1000` indica o número de repetições da simulação.

A distribuição das estatística de interesse
na simulação mostra nem inclui o valor observado.

```{r embaubas distribuicao nula, 
legend="Distribuição das diferenças nas proporções de embaúbas brancas e vermelhas
com lianas em 1000 simulações da hipótese nula de ausência de diferença nas populações amostradas.
A linha vermelha indica a diferença observada."}
hist(emb.r, xlim=c(-0.5, 0.5),
     main = "Distribuição da estatística de interesse sob H0",
     xlab = "Estatística de interesse")
abline(v = emb.ei(embauba), lty=2, col="red")
```
#### Decisão: rejeitamos a hipótese nula?

Seguindo o padrão das ciências biológicas,
adotamos o critério de rejeitar
a hipótese nula se a probabilidade
da estatística de interesse sob a hipótese nula
for menor que 5%.

Este critério é verificado com um teste lógico no
R:

```{r embaubas teste}, 
(sum(emb.r >= emb.ei(embauba))/1000) < 0.05
```
**Conclusão:** rejeita-se a hipótese nula (p<0,05).


### Embaralhando linhas para testar diferenças dentro de pares

O dataframe `azteca` tem o número de formigas *Azteca* sp
recrutadas por extratos aquosos de folhas novas e velhas de
embaúbas.

```{r inspecionando objeto azteca}
head(azteca)
summary(azteca)
```
Saiba mais sobre os dados em sua página de ajuda (`?azteca`).

#### Hipótese do estudo

Uma das hipóteses deste estudo é
que o recrutamento por extrato de folhas novas
seja maior. Essa tendência ocorreu
no dados obtidos no experimento:

```{r pairplot azteca, 
legend = "Número de formigas recrutadas por extratos de folhas novas e velhas de embaúbas.
Os extratos foram aplicados em pares de folhas próximas em embaúbas que tinham colônias de formigas.
As linhas ligam folhas do mesmo par experimental."}
pairs.plot(azteca$extract.new, azteca$extract.old,
           groups.names=c("Folha nova","Folha velha"),
           ylab="N de formigas recrutadas",
           xlab="Tipo de extrato aplicado")
```
#### Hipótese nula
A hipótese nula é de que o recrutamento provocado pelos estratos
é o mesmo. Note que para controlar outras fontes de variação o
experimento foi pareado.
Então para simular a hipótese nula temos que
embaralhar o número de formigas recrutadas **dentro** de cada par de
folhas.


#### Estatística de interesse
A cada simulação temos que calcular nossa
**estatística de interesse**, que é a
média da diferença das folhas de cada par.
Uma função para isso:

```{r estatistica de interesse azteca}
azt.ei <- function(dataframe){
    diferencas <- with(dataframe, extract.new - extract.old)
    mean(diferencas)
}
## Valor observado
azt.ei(azteca)
```
No experimento o extrato de folhas novas recrutou em média `r
round(azt.ei(azteca),1)`
formigas que o extreto de folha velha, em cada par.

#### Distribuição da estatística sob a hipótese nula

Como os pares são linhas em nosso dataframe,
simulamos a hipótese nula embaralhando os valores
dentro de cada linha:

```{r embaubas resampling}
azt.r <- Rsampling(type = "within_rows", dataframe = azteca,
                   statistics = azt.ei, cols = 2:3, ntrials = 1000)
```

Mudamos o argumento `type = "within_rows`, para indicar que
os valores devem ser embaralhados dentro da linhas.
O argumento `cols = 2:3` indica as colunas do dataframe
que têm as contagens.

Uma diferença igual ou maior que a observada foi muito rara
na distribuição da estatística de interesse:

```{r embaubas distribuicao nula, 
legend="Distribuição das diferenças do número de formigas recrutadas
por extratos de folhas novas e velhas de
embaúba em pares experimentais, em 1000 simulações da hipótese nula de ausência de diferença.
A linha vermelha indica a diferença observada."}
hist(azt.r,
     main = "Distribuição da estatística de interesse sob H0",
     xlab = "Estatística de interesse")
abline(v = azt.ei(azteca), lty=2, col="red")
```
#### Decisão: rejeitamos a hipótese nula?

Aplicando nosso critério de significância:

```{r azteca teste}, 
(sum(azt.r >= azt.ei(azteca))/1000) < 0.05
```
**Conclusão:** rejeita-se a hipótese nula (p<0,05).


### Embaralhando linhas para testar diferenças dentro de pares

O dataframe `azteca` tem o número de formigas *Azteca* sp
recrutadas por extratos aquosos de folhas novas e velhas de
embaúbas.

```{r inspecionando objeto azteca}
head(azteca)
summary(azteca)
```
Saiba mais sobre os dados em sua página de ajuda (`?azteca`).

#### Hipótese do estudo

Uma das hipóteses deste estudo é
que o recrutamento por extrato de folhas novas
seja maior. Essa tendência ocorreu
no dados obtidos no experimento:

```{r pairplot azteca, 
legend = "Número de formigas recrutadas por extratos de folhas novas e velhas de embaúbas.
Os extratos foram aplicados em pares de folhas próximas em embaúbas que tinham colônias de formigas.
As linhas ligam folhas do mesmo par experimental."}
pairs.plot(azteca$extract.new, azteca$extract.old,
           groups.names=c("Folha nova","Folha velha"),
           ylab="N de formigas recrutadas",
           xlab="Tipo de extrato aplicado")
```
#### Hipótese nula
A hipótese nula é de que o recrutamento provocado pelos estratos
é o mesmo. Note que para controlar outras fontes de variação o
experimento foi pareado.
Então para simular a hipótese nula temos que
embaralhar o número de formigas recrutadas **dentro** de cada par de
folhas.


#### Estatística de interesse
A cada simulação temos que calcular nossa
**estatística de interesse**, que é a
média da diferença das folhas de cada par.
Uma função para isso:

```{r estatistica de interesse azteca}
azt.ei <- function(dataframe){
    diferencas <- with(dataframe, extract.new - extract.old)
    mean(diferencas)
}
## Valor observado
azt.ei(azteca)
```
No experimento o extrato de folhas novas recrutou em média `r
round(azt.ei(azteca),1)`
formigas que o extreto de folha velha, em cada par.

#### Distribuição da estatística sob a hipótese nula

Como os pares são linhas em nosso dataframe,
simulamos a hipótese nula embaralhando os valores
dentro de cada linha:

```{r azteca resampling}
azt.r <- Rsampling(type = "within_rows", dataframe = azteca,
                   statistics = azt.ei, cols = 2:3, ntrials = 1000)
```

Mudamos o argumento `type = "within_rows`, para indicar que
os valores devem ser embaralhados dentro da linhas.
O argumento `cols = 2:3` indica as colunas do dataframe
que têm as contagens.

Uma diferença igual ou maior que a observada foi muito rara
na distribuição da estatística de interesse:

```{r azteca distribuicao nula, 
legend="Distribuição das diferenças do número de formigas recrutadas
por extratos de folhas novas e velhas de
embaúba em pares experimentais, em 1000 simulações da hipótese nula de ausência de diferença.
A linha vermelha indica a diferença observada."}
hist(azt.r,
     main = "Distribuição da estatística de interesse sob H0",
     xlab = "Estatística de interesse")
abline(v = azt.ei(azteca), lty=2, col="red")
```
#### Decisão: rejeitamos a hipótese nula?

Aplicando nosso critério de significância:

```{r azteca teste}, 
(sum(azt.r >= azt.ei(azteca))/1000) < 0.05
```
**Conclusão:** rejeita-se a hipótese nula (p<0,05).

